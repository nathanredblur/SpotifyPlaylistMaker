---
import AppLayout from "@/layouts/AppLayout.astro";
---

<AppLayout title="Organize Your Music - Loading">
  <div id="app-root">
    <!-- Loading placeholder while React initializes -->
    <div
      class="min-h-screen bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950 flex items-center justify-center"
    >
      <div class="text-white text-center">
        <div
          class="animate-spin rounded-full h-16 w-16 border-b-2 border-green-500 mx-auto mb-4"
        >
        </div>
        <p class="text-lg">Initializing...</p>
      </div>
    </div>
  </div>

  <script>
    import { createElement } from "react";
    import { createRoot } from "react-dom/client";
    import { MusicOrganizer } from "@/components/MusicOrganizer";
    import { parseAuthHash, clearAuthHash } from "@/lib/spotify-api";
    import { setAccessToken, getAccessToken } from "@/lib/spotify-auth";

    /**
     * Handle OAuth callback and initialize the app
     */
    function initializeApp() {
      try {
        // Parse auth hash from URL (Spotify redirects with #access_token=...)
        const { accessToken, error } = parseAuthHash();

        if (error) {
          console.error("Spotify authorization error:", error);
          alert(`Authorization failed: ${error}\n\nPlease try again.`);
          window.location.href = "/";
          return;
        }

        // If we got a fresh token from Spotify, store it
        if (accessToken) {
          console.log("✅ Received access token from Spotify");
          setAccessToken(accessToken);
          clearAuthHash(); // Clean up the URL
        }

        // Check if we have a valid token (either from URL or localStorage)
        const token = getAccessToken();

        if (!token) {
          console.warn("⚠️ No valid access token found, redirecting to home");
          window.location.href = "/";
          return;
        }

        console.log("✅ Valid token found, initializing app");

        // Mount the React app
        const root = document.getElementById("app-root");
        if (!root) {
          throw new Error("Root element not found");
        }

        // Use createElement instead of JSX (Astro scripts don't support JSX)
        createRoot(root).render(
          createElement(MusicOrganizer, { accessToken: token })
        );
      } catch (error) {
        console.error("Failed to initialize app:", error);
        alert(
          "An error occurred while initializing the app.\n\n" +
            "Please try refreshing the page or contact support if the problem persists."
        );
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeApp);
    } else {
      initializeApp();
    }
  </script>
</AppLayout>
